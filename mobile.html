<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Holy Rosary - Mobile</title>
    <link rel="icon" type="image/png" href="/images/png/favicon.png">
    <link rel="stylesheet" href="https://fontlibrary.org/assets/fonts/analecta/8c7f0b7a8b8e7f8b7f8b7f8b7f8b7f8b/analecta.css" type="text/css"/>
    <link rel="stylesheet" href="https://fontlibrary.org/assets/fonts/rawline/9d8f0b7a8b8e7f8b7f8b7f8b7f8b7f8b/rawline.css" type="text/css"/>
    <style>
        /* Existing styles remain unchanged */
    </style>
</head>
<body>
    <div class="header">
        <button class="nav-toggle">â˜°</button>
        <h1>The Holy Rosary</h1>
        <div class="nav-menu">
            <ul id="nav-links">
                <!-- Navigation links populated dynamically -->
            </ul>
        </div>
    </div>
    <div class="container">
        <div class="content" id="main-content">
            <p>Loading...</p>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Toggle mobile menu
            document.querySelector('.nav-toggle').addEventListener('click', () => {
                document.querySelector('.nav-menu').classList.toggle('active');
            });

            // Function to clean and fix content
            function cleanContent(content, baseUrl) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = content.innerHTML;

                // Remove all script tags to prevent execution of goToNewPage
                tempDiv.querySelectorAll('script').forEach(script => script.remove());

                // Remove topnav and base tags
                tempDiv.querySelectorAll('div.topnav').forEach(nav => nav.remove());
                tempDiv.querySelectorAll('base').forEach(base => base.remove());

                // Fix stylesheet links
                tempDiv.querySelectorAll('link[href="../latin.css"]').forEach(link => {
                    link.setAttribute('href', '/latin.css');
                });

                // Remove praying hands image and following <br>
                tempDiv.querySelectorAll('p > img[src="/images/png/prayinghands.png"]').forEach(img => {
                    const p = img.parentElement;
                    const br = p.nextElementSibling;
                    if (br && br.tagName === 'BR') br.remove();
                    p.remove();
                });

                // Handle YouTube dropdowns
                tempDiv.querySelectorAll('select[name="Rosary"]').forEach(select => {
                    // Check if this select contains YouTube URLs
                    const hasYouTube = Array.from(select.querySelectorAll('option'))
                        .some(option => option.value.startsWith('https://www.youtube.com'));
                    if (hasYouTube) {
                        console.log('Found YouTube select:', select.outerHTML);
                        // Remove existing button if present
                        const next = select.nextElementSibling;
                        if (next && next.tagName === 'INPUT' && next.type === 'button') {
                            console.log('Removing existing button:', next.outerHTML);
                            next.remove();
                        }
                        // Inject new Go button
                        const goButton = document.createElement('input');
                        goButton.type = 'button';
                        goButton.value = 'Go';
                        goButton.classList.add('youtube-go-button');
                        select.insertAdjacentElement('afterend', goButton);
                        console.log('Injected Go button:', goButton.outerHTML);
                    }
                });

                // Remove inline onclick attributes from all buttons
                tempDiv.querySelectorAll('button, input[type="button"], input[type="submit"]').forEach(btn => {
                    if (btn.hasAttribute('onclick')) {
                        btn.removeAttribute('onclick');
                    }
                });

                // Adjust links
                tempDiv.querySelectorAll('a[href="/app/rosary.html"]').forEach(link => {
                    link.setAttribute('target', '_self');
                });
                tempDiv.querySelectorAll('a').forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && baseUrl.includes('/trent/trent.html') && !href.startsWith('http') && !href.startsWith('/') && !href.includes('/trent/')) {
                        link.setAttribute('href', `/trent/${href}`);
                    }
                    if (href && !href.startsWith('http') && !href.startsWith('#') && !href.includes('/app/rosary.html')) {
                        link.setAttribute('target', '');
                    }
                });

                return tempDiv.innerHTML;
            }

            // Function to load content from a URL
            function loadContent(url) {
                const cleanUrl = url.split('#')[0];
                console.log('Loading content from:', cleanUrl);
                fetch(cleanUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                        return response.text();
                    })
                    .then(data => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(data, 'text/html');
                        const content = doc.querySelector('body') || doc.body;
                        const mainContent = document.getElementById('main-content');
                        mainContent.innerHTML = cleanContent(content, cleanUrl);

                        // Add top link
                        const topLink = document.createElement('a');
                        topLink.href = '#';
                        topLink.className = 'top-link';
                        topLink.textContent = 'Top';
                        mainContent.appendChild(topLink);

                        // Attach existing listeners
                        attachContentLinkListeners();
                        attachMenuListeners();

                        // Attach YouTube button listeners
                        const goButtons = mainContent.querySelectorAll('.youtube-go-button');
                        console.log('Found YouTube buttons:', goButtons.length);
                        goButtons.forEach(button => {
                            const select = button.previousElementSibling;
                            if (select && select.tagName === 'SELECT' && select.name === 'Rosary') {
                                console.log('Attaching listener to button:', button.outerHTML);
                                button.addEventListener('click', () => {
                                    const url = select.value;
                                    console.log('Opening URL:', url);
                                    if (url && url.startsWith('http')) {
                                        window.open(url, '_blank');
                                        console.log('Opened URL in new tab');
                                    } else {
                                        console.log('Invalid URL:', url);
                                    }
                                });
                            }
                        });

                        // Scroll to top
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                        mainContent.scrollTo({ top: 0, behavior: 'smooth' });
                    })
                    .catch(error => {
                        console.error('Error fetching content:', error);
                        document.getElementById('main-content').innerHTML = '<p class="error-message">Failed to load content. Check your connection or try again later.</p>';
                    });
            }

            // Function to attach click listeners to menu links
            function attachMenuListeners() {
                const menuLinks = document.querySelectorAll('.nav-menu a');
                menuLinks.forEach(link => {
                    link.removeEventListener('click', link._handler);
                    const handler = (e) => {
                        e.preventDefault();
                        const href = link.getAttribute('href');
                        const target = link.getAttribute('target');
                        if (href && href !== '#') {
                            if (target === '_self' || href.includes('/app/rosary.html')) {
                                window.location.href = href;
                            } else if (target === '_blank') {
                                window.open(href, '_blank');
                                document.querySelector('.nav-menu').classList.remove('active');
                            } else {
                                loadContent(href);
                                document.querySelector('.nav-menu').classList.remove('active');
                            }
                        }
                    };
                    link._handler = handler;
                    link.addEventListener('click', handler);
                });
            }

            // Function to attach click listeners to content links
            function attachContentLinkListeners() {
                const contentLinks = document.querySelectorAll('.content a:not(.top-link)');
                contentLinks.forEach(link => {
                    link.removeEventListener('click', link._handler);
                    const handler = (e) => {
                        e.preventDefault();
                        const href = link.getAttribute('href');
                        const target = link.getAttribute('target');
                        if (href && (href.includes('/app/rosary.html') || target === '_self')) {
                            window.location.href = href;
                        } else if (href && href.startsWith('http')) {
                            window.open(href, '_blank');
                        } else if (href === '#' || href === '#top') {
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        } else if (href && href !== '#') {
                            const resolvedUrl = href.startsWith('/') ? href : `/${href}`;
                            loadContent(resolvedUrl);
                        }
                    };
                    link._handler = handler;
                    link.addEventListener('click', handler);
                });
            }

            // Fallback menu
            const fallbackMenu = [
                { text: 'English Rosary', href: '/rosary.html' },
                { text: 'Latin Rosary', href: '/latin.html' },
                { text: 'Mysteries', href: '/mysteries.html' },
                { text: 'Rosary Guide', href: '/rosary_guide.html' },
                { text: 'Catechism', href: '/trent/trent.html' },
                { text: 'Rosary App', href: '/app/rosary.html', target: '_self' },
                { text: 'Contact', href: 'https://form.jotform.com/210341816022138', target: '_blank' }
            ];

            // Fetch topnav and initialize
            fetch('/rosary.html')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    return response.text();
                })
                .then(data => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(data, 'text/html');
                    const topnav = doc.querySelector('div.topnav');
                    const navLinks = document.getElementById('nav-links');
                    if (topnav) {
                        const links = topnav.querySelectorAll('a');
                        navLinks.innerHTML = '';
                        links.forEach(link => {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.href = link.href.includes('http') ? link.href : '/' + link.href.replace(/^\//, '');
                            a.textContent = link.textContent.trim();
                            li.appendChild(a);
                            navLinks.appendChild(li);
                        });
                        const customLinks = [
                            { text: 'Rosary App', href: '/app/rosary.html', target: '_self' },
                            { text: 'Contact', href: 'https://form.jotform.com/210341816022138', target: '_blank' }
                        ];
                        customLinks.forEach(item => {
                            const li = document.createElement('li');
                            const a = document.createElement('a');
                            a.href = item.href;
                            a.textContent = item.text;
                            if (item.target) a.setAttribute('target', item.target);
                            li.appendChild(a);
                            navLinks.appendChild(li);
                        });
                        loadContent('/rosary.html');
                        attachMenuListeners();
                    } else {
                        throw new Error('Topnav not found');
                    }
                })
                .catch(error => {
                    console.error('Error fetching topnav:', error);
                    const navLinks = document.getElementById('nav-links');
                    navLinks.innerHTML = '';
                    fallbackMenu.forEach(item => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.href = item.href;
                        a.textContent = item.text;
                        if (item.target) a.setAttribute('target', item.target);
                        li.appendChild(a);
                        navLinks.appendChild(li);
                    });
                    document.getElementById('main-content').innerHTML = '<p class="error-message">Failed to load navigation. Using fallback menu.</p>';
                    loadContent('/rosary.html');
                    attachMenuListeners();
                });
        });
    </script>
</body>
</html>
